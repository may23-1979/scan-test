# .semgrep/php-xss.yml
# ─────────────────────────────────────────────────────────────
# 目的:  ユーザ入力を HTML に未エスケープで出力している XSS を検出
# 対象:  PHP
# 機能:  taint-mode で
#         ① スーパーグローバル／QUERY_STRING を汚染源 (source)
#         ② parse_str() と flattenQuery() をプロパゲータ (propagator)
#         ③ echo / print をシンク (sink)
#         ④ htmlspecialchars() / htmlentities() をサニタイザ (sanitizer)
# ─────────────────────────────────────────────────────────────
rules:
  - id: php-xss-output
    languages: [php]
    message: "ユーザ入力を HTML に未エスケープで出力しています (XSS)。"
    severity: ERROR
    mode: taint

    # ① 汚染源 ────────────────────────────
    pattern-sources:
      - pattern-either:
          - pattern: $_GET[..]
          - pattern: $_POST[..]
          - pattern: $_REQUEST[..]
          - pattern: $_COOKIE[..]
          - pattern: $_SERVER['QUERY_STRING']

    # ② プロパゲータ ──────────────────────
    pattern-propagators:
      # parse_str($tainted, $out) → $out が tainted
      - pattern: |
          parse_str($IN, $OUT)
        from: $IN
        to:   $OUT

      # 任意の flattenQuery(汚染配列) → 戻り値も tainted
      - pattern: |
          $RES = flattenQuery($ARG)
        from: $ARG
        to:   $RES

    # ③ シンク ────────────────────────────
    pattern-sinks:
      - pattern-either:
          - pattern: echo $X;
          - pattern: print $X;

    # ④ サニタイザ ────────────────────────
    pattern-sanitizers:
      - pattern-either:
          - pattern: htmlspecialchars(...)
          - pattern: htmlentities(...)

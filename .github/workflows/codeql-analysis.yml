name: Semgrep Code Scanning Workflow
on:
  push:
    branches: ["main"]    # Run on pushes to the main branch
  pull_request:
    branches: ["main"]    # Run on pull requests targeting the main branch

permissions:
  contents: read          # Allow read access to the repository content (for checkout)
  security-events: write  # Required to upload SARIF results to GitHub Code Scanning:contentReference[oaicite:1]{index=1}
  # Note: For private repositories, also add `actions: read` permission for upload-sarif to access workflow run info.

jobs:
  semgrep:
    name: Run Semgrep scan
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3
        # Fetches the repository content so it can be scanned by Semgrep

      - name: Run Semgrep (PHP & JavaScript)
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/src" \
            -w /src \
            semgrep/semgrep:latest \
            semgrep --config auto --include '**/*.php' --include '**/*.js' --sarif -o semgrep.sarif .
        # Use the Semgrep CLI in the official Docker container to scan only PHP and JS files.
        # The '--include' globs ensure only *.php and *.js files are analyzed.
        # Results are output in SARIF format and saved to semgrep.sarif

      - name: Ensure SARIF file exists
        run: |
          if [ ! -f semgrep.sarif ] || [ ! -s semgrep.sarif ]; then
            echo '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"Semgrep"}},"results":[]}]}'> semgrep.sarif
          fi
        # If the SARIF file is missing or empty, generate a minimal SARIF with no results.
        # This prevents the upload step from failing (code scanning expects an empty 'runs' entry when no alerts are found:contentReference[oaicite:2]{index=2}).

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        # Upload the SARIF report to GitHub Code Scanning (Security tab)
